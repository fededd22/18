<?php
// ╪е╪╣╪п╪з╪п ╪з┘Д╪к┘В╪з╪▒┘К╪▒ ╪╣┘Ж ╪з┘Д╪г╪о╪╖╪з╪б
error_reporting(E_ALL);
ini_set('display_errors', 1);

echo '
таАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтг╝тбЗтаАтаАтаАтаАтаАтаАтаАтаАтгатг╛тг┐таАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаА
таАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтг╝тг┐тгзтаАтаАтаАтаАтаАтаАтгатг╛таЯтг┐тбЯтаАтаАтаАтаАтаАтаАтгатгДтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаА
таАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтвАтбАтаАтаАтаАтг╕тг┐та╣тг┐тбДтаАтаАтаАтвАтг╝тбЯтаБтаАтв╛тбЗтаАтаАтаАтгАтг┤тг┐тб┐таБтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаА
таАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтв╕тгЗтаАтаАтвАтг┐тбЗтаАтв╗тг┐тбАтаАтвАтг┐тбЯтаАтаАтаАтг┐тбЗтаАтвАтг╝тб┐тв┐тг┐таЗтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаА
таАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтв╕тг┐тгЖтаАтг╕тг┐таАтаАтаАта╗тг╖тгдтг╛таПтаАтаАтаАтаАтг┐тгзтг╢тб┐таЛтаАтг╝тбПтаАтаАтаАтаАтаАтаАтгатбДтаАтаАтаАтаАтаАтаА
таАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАта╕тг┐тг┐тг╢тг┐тбПтаАтаАтаАтаАтаЩта┐таЛтаАтаАтаАтаАтаАта╕таЯтаБтаАтаАтвАтг┐таГтаАтвАтгАтгдтг╛тг┐тб┐таБтаАтаАтаАтаАтаАтаА
таАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтг┐тбЖтаЩта┐таГтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАта╕тг┐тг╢тб╢таЯтаЛтаЙтг╝тбЯтаБтаАтаАтаАтаАтаАтаАтаА
таАтаАтаАтаАтаАтаАтаАтаАтаАтаАтв╛тг╢тг╢тг╢тг╢тг╢тг╢тгдтг╛тг┐тбДтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаИтаАтаАтаАтватг╛таПтвАтгАтгатбАтаАтаАтаАтаАтаА
таАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаЙтаЫтв╖тгжтбАтаАтаАтаЙтаЙтаБтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтвАтг┤тг┐тг┐тг┐тг┐таЯтаЛтаАтаАтаАтаАтаАтаА
таАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаЩтв╗тгжтбАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтвАтгмтг┐тг┐тгптгАтгАтбАтаАтаАтаАтаАтаАтаА
таАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАта░тг╢тг╢тг╢тг╢тг┐тб┐таЖтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаИтаЙтаЙтаЙтгйтг┐тб┐таПтаАтаАтаАтаАтаА
таАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаИтаЩта╗тв┐тг╖тгдтгдтгдтгдтг╢тг╢та╛та┐та┐тв┐тг┐тг┐тг┐тг┐тг┐тг╖тг╢тг╢тг╢тгдтгдтгдтгАтбАтаАтаАтаАтгатгдтг╢та┐таЫтаЙтаАтаАтаАтаАтаАтаАтаА
таАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаИтв╣тбЯтаЙтвбтг┤тг╢тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тгЯтгЛтаЙтаЙтаЙтаЫта╗та┐тг┐тг╖тг╢тг┐тг┐тгжтаАтаАтаАтаАтаАтаАтаАтаАтаАтаА
таАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтв╕тбЗтаАтвАтгатгдтгнтгнтг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тгжтгДтгАтбАтаАтаАтаИтг┐тбПтаЩтаЫтаЧтаАтаАтаАтаАтаАтаАтаАтаАтаА
таАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтв╕тбЗтв░тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг╖тватг┐таБтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаА
таАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаА таАтватг┐тг╖тбШтв┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тбНтаЩта╗тв┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг╛тг┐тгЖтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаА
таАтаАтаАтаАтаА тг┤тг╢тгДтаА  таАтаАтаАтаАтвАтб┐таАтг┐тб┐тг╖тг┐тг┐тг┐тб┐та┐таЯтаЫтаЫта┐та┐тг╖тгдтгдтгдтгдтгнтг╛тг┐та┐таЯта╗тг┐тбЯтг┐таАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаА
таАтг┤тг╢тгдтбАтаАтг┐таЙтг┐тбЖтаАтаАтаАтаАтаАтаИтг┐таАтв╕тбЗтаАтаИтаБтаАтаАтаАтаАтаАтаАтаАтаАтаАтаЙтаЙтаЫтаЫтаЙтаБтаАтаАтаАтаАтаЛтватг┐  твАтг┤тг┐тг╖таАтаАтаА
таАтг┐тбЗта╣тг┐тгдтг┐тбДтв╕тг╖таАтаАтаАтаАтаАтаАта╣твзтг╝таАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтвАтгАтг░тб┐таГ таАтв╕тг╖тбАтаШтг┐тбЯтаАтаАтг░тг┐таБтаАтаА
таАтаАтаАтаАтаАтаЩта╗та┐та┐та┐таЯтаЛтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаЩтв┐тг╢тг╝тгдтгдтг╛таЯтаБтаАтаАтаА
таАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаА таАтаАтаАтаАтаАтаАтаЙтаЙтаЙтаАтаАтаАтаАтаАтаАтаА
{3}
';

// ╪з┘Д╪л┘И╪з╪и╪к
define('TOKEN', '8237553046:AAFn-hpNYOALIjk8c002-0Be_jmbEzEeuMU');
define('ADMIN_ID', 1772564386);
define('YOUR_USERNAME', '@hgjvfgdtgd');

// ╪з┘Д┘Е╪к╪║┘К╪▒╪з╪к ╪з┘Д╪╣╪з┘Е╪й
$uploaded_files_dir = 'uploaded_bots';
$bot_scripts = [];
$stored_tokens = [];
$user_files = [];
$active_users = [];
$admins_list = [ADMIN_ID];
$bot_locked = false;
$last_update_id = 0;

// ╪е┘Ж╪┤╪з╪б ╪з┘Д┘Е╪м┘Д╪п ╪е╪░╪з ┘Д┘Е ┘К┘Г┘Ж ┘Е┘И╪м┘И╪п╪з┘Л
if (!file_exists($uploaded_files_dir)) {
    mkdir($uploaded_files_dir, 0777, true);
}

// ╪к┘З┘К╪ж╪й ┘В╪з╪╣╪п╪й ╪з┘Д╪и┘К╪з┘Ж╪з╪к
function init_db() {
    $conn = new SQLite3('bot_data.db');
    
    // ╪м╪п┘И┘Д ╪з┘Д┘Е┘Д┘Б╪з╪к
    $conn->exec('CREATE TABLE IF NOT EXISTS user_files (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_id INTEGER, 
        file_name TEXT
    )');
    
    // ╪м╪п┘И┘Д ╪з┘Д┘Е╪│╪к╪о╪п┘Е┘К┘Ж ╪з┘Д┘Ж╪┤╪╖┘К┘Ж
    $conn->exec('CREATE TABLE IF NOT EXISTS active_users (
        user_id INTEGER PRIMARY KEY
    )');
    
    // ╪м╪п┘И┘Д ╪з┘Д╪г╪п┘Е┘Ж┘К╪й
    $conn->exec('CREATE TABLE IF NOT EXISTS admins (
        user_id INTEGER PRIMARY KEY
    )');
    
    // ╪е╪╢╪з┘Б╪й ╪з┘Д╪г╪п┘Е┘Ж ╪з┘Д╪г╪│╪з╪│┘К
    $stmt = $conn->prepare('INSERT OR IGNORE INTO admins (user_id) VALUES (?)');
    $stmt->bindValue(1, ADMIN_ID, SQLITE3_INTEGER);
    $stmt->execute();
    
    $conn->close();
}

// ╪к╪н┘Е┘К┘Д ╪з┘Д╪и┘К╪з┘Ж╪з╪к ┘Е┘Ж ┘В╪з╪╣╪п╪й ╪з┘Д╪и┘К╪з┘Ж╪з╪к
function load_data() {
    global $user_files, $active_users, $admins_list;
    
    $conn = new SQLite3('bot_data.db');
    
    // ╪к╪н┘Е┘К┘Д ╪з┘Д┘Е┘Д┘Б╪з╪к
    $result = $conn->query('SELECT user_id, file_name FROM user_files');
    while ($row = $result->fetchArray(SQLITE3_ASSOC)) {
        $user_id = $row['user_id'];
        $file_name = $row['file_name'];
        if (!isset($user_files[$user_id])) {
            $user_files[$user_id] = [];
        }
        $user_files[$user_id][] = $file_name;
    }
    
    // ╪к╪н┘Е┘К┘Д ╪з┘Д┘Е╪│╪к╪о╪п┘Е┘К┘Ж ╪з┘Д┘Ж╪┤╪╖┘К┘Ж
    $result = $conn->query('SELECT * FROM active_users');
    while ($row = $result->fetchArray(SQLITE3_ASSOC)) {
        $active_users[] = $row['user_id'];
    }
    
    // ╪к╪н┘Е┘К┘Д ╪з┘Д╪г╪п┘Е┘Ж┘К╪й
    $result = $conn->query('SELECT * FROM admins');
    $admins_list = [];
    while ($row = $result->fetchArray(SQLITE3_ASSOC)) {
        $admins_list[] = $row['user_id'];
    }
    
    $conn->close();
}

// ╪н┘Б╪╕ ┘Е┘Д┘Б ╪з┘Д┘Е╪│╪к╪о╪п┘Е
function save_user_file($user_id, $file_name) {
    $conn = new SQLite3('bot_data.db');
    $stmt = $conn->prepare('INSERT INTO user_files (user_id, file_name) VALUES (?, ?)');
    $stmt->bindValue(1, $user_id, SQLITE3_INTEGER);
    $stmt->bindValue(2, $file_name, SQLITE3_TEXT);
    $stmt->execute();
    $conn->close();
}

// ╪е╪╢╪з┘Б╪й ┘Е╪│╪к╪о╪п┘Е ┘Ж╪┤╪╖
function add_active_user($user_id) {
    $conn = new SQLite3('bot_data.db');
    $stmt = $conn->prepare('INSERT OR IGNORE INTO active_users (user_id) VALUES (?)');
    $stmt->bindValue(1, $user_id, SQLITE3_INTEGER);
    $stmt->execute();
    $conn->close();
}

// ╪з┘Д╪к╪н┘В┘В ╪е╪░╪з ┘Г╪з┘Ж ╪з┘Д┘Е╪│╪к╪о╪п┘Е ╪г╪п┘Е┘Ж
function is_admin($user_id) {
    global $admins_list;
    return in_array($user_id, $admins_list);
}

// ╪е┘Ж╪┤╪з╪б ╪з┘Д┘В╪з╪ж┘Е╪й ╪з┘Д╪▒╪ж┘К╪│┘К╪й
function create_main_menu($user_id) {
    $keyboard = [
        'inline_keyboard' => []
    ];
    
    $upload_button = ['text' => 'ЁЯУд ╪▒┘Б╪╣ ┘Е┘Д┘Б', 'callback_data' => 'upload'];
    $speed_button = ['text' => 'тЪб ╪│╪▒╪╣╪й ╪з┘Д╪и┘И╪к', 'callback_data' => 'speed'];
    $contact_button = ['text' => 'ЁЯУЮ ╪к┘И╪з╪╡┘Д ┘Е╪╣ ╪з┘Д┘Е╪з┘Д┘Г', 'url' => 'https://t.me/' . substr(YOUR_USERNAME, 1)];
    
    if (is_admin($user_id)) {
        $lock_button = ['text' => 'ЁЯФТ ┘В┘Б┘Д ╪з┘Д╪и┘И╪к', 'callback_data' => 'lock_bot'];
        $unlock_button = ['text' => 'ЁЯФУ ┘Б╪к╪н ╪з┘Д╪и┘И╪к', 'callback_data' => 'unlock_bot'];
        $broadcast_button = ['text' => 'ЁЯУв ╪е╪░╪з╪╣╪й', 'callback_data' => 'broadcast'];
        $add_admin_button = ['text' => 'ЁЯСд ╪е╪╢╪з┘Б╪й ╪г╪п┘Е┘Ж', 'callback_data' => 'add_admin'];
        
        $keyboard['inline_keyboard'][] = [$upload_button];
        $keyboard['inline_keyboard'][] = [$speed_button];
        $keyboard['inline_keyboard'][] = [$lock_button, $unlock_button];
        $keyboard['inline_keyboard'][] = [$broadcast_button, $add_admin_button];
    } else {
        $keyboard['inline_keyboard'][] = [$upload_button];
        $keyboard['inline_keyboard'][] = [$speed_button];
    }
    
    $keyboard['inline_keyboard'][] = [$contact_button];
    
    return json_encode($keyboard);
}

// ╪е╪▒╪│╪з┘Д ╪▒╪│╪з┘Д╪й
function send_message($chat_id, $text, $reply_markup = null) {
    $data = [
        'chat_id' => $chat_id,
        'text' => $text
    ];
    
    if ($reply_markup) {
        $data['reply_markup'] = $reply_markup;
    }
    
    return make_request('sendMessage', $data);
}

// ╪е╪м╪▒╪з╪б ╪╖┘Д╪и ╪е┘Д┘Й API ╪з┘Д╪к┘К┘Д┘К╪м╪▒╪з┘Е
function make_request($method, $data) {
    $url = "https://api.telegram.org/bot" . TOKEN . "/" . $method;
    
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
    curl_setopt($ch, CURLOPT_TIMEOUT, 10);
    
    $result = curl_exec($ch);
    $http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    
    if (curl_error($ch)) {
        error_log("cURL Error: " . curl_error($ch));
    }
    
    curl_close($ch);
    
    return $result ? json_decode($result, true) : false;
}

// ╪з┘Д╪н╪╡┘И┘Д ╪╣┘Д┘Й ╪з┘Д╪к╪н╪п┘К╪л╪з╪к
function get_updates($offset = 0) {
    $url = "https://api.telegram.org/bot" . TOKEN . "/getUpdates?offset=" . $offset . "&timeout=30";
    
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
    curl_setopt($ch, CURLOPT_TIMEOUT, 35); // ╪г╪▓┘К╪п ┘Е┘Ж ╪з┘Д┘И┘В╪к ┘В┘Д┘К┘Д╪з┘Л
    
    $result = curl_exec($ch);
    
    if (curl_error($ch)) {
        error_log("cURL Error in getUpdates: " . curl_error($ch));
        curl_close($ch);
        return [];
    }
    
    curl_close($ch);
    
    $response = json_decode($result, true);
    
    if ($response && $response['ok']) {
        return $response['result'];
    }
    
    return [];
}

// ┘Е╪╣╪з┘Д╪м╪й ╪г┘Е╪▒ /start
function handle_start($message) {
    global $bot_locked, $active_users;
    
    $chat_id = $message['chat']['id'];
    $user_id = $message['from']['id'];
    $user_name = $message['from']['first_name'];
    $user_username = $message['from']['username'] ?? '┘Д╪з ┘К┘И╪м╪п';
    
    if ($bot_locked && !is_admin($user_id)) {
        send_message($chat_id, "тЪая╕П ╪з┘Д╪и┘И╪к ┘Е┘В┘Б┘Д ╪н╪з┘Д┘К╪з┘Л. ╪з┘Д╪▒╪м╪з╪б ╪з┘Д┘Е╪н╪з┘И┘Д╪й ┘Д╪з╪н┘В┘Л╪з.");
        return;
    }
    
    $user_bio = "┘Д╪з ┘К┘И╪м╪п ╪и╪з┘К┘И";
    
    if (!in_array($user_id, $active_users)) {
        $active_users[] = $user_id;
        add_active_user($user_id);
        
        if (is_admin(ADMIN_ID)) {
            $welcome_message = "ЁЯОЙ ╪з┘Ж╪╢┘Е ┘Е╪│╪к╪о╪п┘Е ╪м╪п┘К╪п ╪е┘Д┘Й ╪з┘Д╪и┘И╪к!\n\n";
            $welcome_message .= "ЁЯСд ╪з┘Д╪з╪│┘Е: {$user_name}\n";
            $welcome_message .= "ЁЯУМ ╪з┘Д┘К┘И╪▓╪▒: @{$user_username}\n";
            $welcome_message .= "ЁЯЖФ ╪з┘Д┘А ID: {$user_id}\n";
            $welcome_message .= "ЁЯУЭ ╪з┘Д╪и╪з┘К┘И: {$user_bio}\n";
            
            send_message(ADMIN_ID, $welcome_message);
        }
    }
    
    $welcome_message = "уА╜я╕ПтФЗ╪з┘З┘Д╪з ╪и┘Г: {$user_name}\n";
    $welcome_message .= "ЁЯЖФтФЗ╪з┘К╪п┘К┘Г: {$user_id}\n";
    $welcome_message .= "тЩ╗я╕ПтФЗ┘К┘И╪▓╪▒┘Г: @{$user_username}\n";
    $welcome_message .= "ЁЯУ░тФЗ╪и╪з┘К┘И: {$user_bio}\n\n";
    $welcome_message .= "уА╜я╕П ╪г┘Ж╪з ╪и┘И╪к ╪з╪│╪к╪╢╪з┘Б╪й ┘Е┘Д┘Б╪з╪к ╪и╪з┘К╪л┘И┘Ж ЁЯОЧ ┘К┘Е┘Г┘Ж┘Г ╪з╪│╪к╪о╪п╪з┘Е ╪з┘Д╪г╪▓╪▒╪з╪▒ ╪г╪п┘Ж╪з┘З ┘Д┘Д╪к╪н┘Г┘Е тЩ╗я╕П";
    
    send_message($chat_id, $welcome_message, create_main_menu($user_id));
}

// ┘Е╪╣╪з┘Д╪м╪й ╪з┘Д╪▒╪п┘И╪п
function handle_callback_query($callback) {
    $data = $callback['data'];
    $chat_id = $callback['from']['id'];
    $message_id = $callback['message']['message_id'];
    
    switch ($data) {
        case 'upload':
            send_message($chat_id, "ЁЯУД ┘Е┘Ж ┘Б╪╢┘Д┘Г╪М ╪г╪▒╪│┘Д ╪з┘Д┘Е┘Д┘Б ╪з┘Д╪░┘К ╪к╪▒┘К╪п ╪▒┘Б╪╣┘З.");
            break;
            
        case 'speed':
            $start_time = microtime(true);
            $response = make_request('getMe', []);
            $latency = microtime(true) - $start_time;
            
            if ($response && $response['ok']) {
                send_message($chat_id, "тЪб ╪│╪▒╪╣╪й ╪з┘Д╪и┘И╪к: " . round($latency, 2) . " ╪л╪з┘Ж┘К╪й.");
            } else {
                send_message($chat_id, "тЪая╕П ┘Б╪┤┘Д ┘Б┘К ╪з┘Д╪н╪╡┘И┘Д ╪╣┘Д┘Й ╪│╪▒╪╣╪й ╪з┘Д╪и┘И╪к.");
            }
            break;
            
        case 'lock_bot':
            if (is_admin($chat_id)) {
                global $bot_locked;
                $bot_locked = true;
                send_message($chat_id, "ЁЯФТ ╪к┘Е ┘В┘Б┘Д ╪з┘Д╪и┘И╪к.");
            } else {
                send_message($chat_id, "тЪая╕П ╪г┘Ж╪к ┘Д╪│╪к ╪г╪п┘Е┘Ж.");
            }
            break;
            
        case 'unlock_bot':
            if (is_admin($chat_id)) {
                global $bot_locked;
                $bot_locked = false;
                send_message($chat_id, "ЁЯФУ ╪к┘Е ┘Б╪к╪н ╪з┘Д╪и┘И╪к.");
            } else {
                send_message($chat_id, "тЪая╕П ╪г┘Ж╪к ┘Д╪│╪к ╪г╪п┘Е┘Ж.");
            }
            break;
            
        case 'broadcast':
            if (is_admin($chat_id)) {
                send_message($chat_id, "╪г╪▒╪│┘Д ╪з┘Д╪▒╪│╪з┘Д╪й ╪з┘Д╪к┘К ╪к╪▒┘К╪п ╪е╪░╪з╪╣╪к┘З╪з:");
            } else {
                send_message($chat_id, "тЪая╕П ╪г┘Ж╪к ┘Д╪│╪к ╪г╪п┘Е┘Ж.");
            }
            break;
            
        case 'add_admin':
            if (is_admin($chat_id)) {
                send_message($chat_id, "╪г╪▒╪│┘Д ┘Е╪╣╪▒┘Б ╪з┘Д┘Е╪│╪к╪о╪п┘Е ╪з┘Д╪░┘К ╪к╪▒┘К╪п ╪м╪╣┘Д┘З ╪г╪п┘Е┘Ж:");
            } else {
                send_message($chat_id, "тЪая╕П ╪г┘Ж╪к ┘Д╪│╪к ╪г╪п┘Е┘Ж.");
            }
            break;
    }
}

// ┘Е╪╣╪з┘Д╪м╪й ╪з┘Д┘Е┘Д┘Б╪з╪к
function handle_document($message) {
    global $bot_locked, $user_files, $uploaded_files_dir;
    
    $chat_id = $message['chat']['id'];
    $user_id = $message['from']['id'];
    $document = $message['document'];
    
    if ($bot_locked && !is_admin($user_id)) {
        send_message($chat_id, "тЪая╕П ╪з┘Д╪и┘И╪к ┘Е┘В┘Б┘Д ╪н╪з┘Д┘К╪з┘Л. ╪з┘Д╪▒╪м╪з╪б ╪з┘Д╪к┘И╪з╪╡┘Д ┘Е╪╣ ╪з┘Д┘Е╪╖┘И╪▒.");
        return;
    }
    
    $file_id = $document['file_id'];
    $file_name = $document['file_name'];
    
    if (!preg_match('/\.(py|zip)$/i', $file_name)) {
        send_message($chat_id, "тЪая╕П ┘З╪░╪з ╪з┘Д╪и┘И╪к ╪о╪з╪╡ ╪и╪▒┘Б╪╣ ┘Е┘Д┘Б╪з╪к ╪и╪з┘К╪л┘И┘Ж (.py) ╪г┘И ╪г╪▒╪┤┘К┘Б╪з╪к zip ┘Б┘В╪╖.");
        return;
    }
    
    // ╪м┘Д╪и ┘Е╪╣┘Д┘И┘Е╪з╪к ╪з┘Д┘Е┘Д┘Б
    $file_info = make_request('getFile', ['file_id' => $file_id]);
    if (!$file_info || !$file_info['ok']) {
        send_message($chat_id, "тЭМ ┘Б╪┤┘Д ┘Б┘К ╪м┘Д╪и ┘Е╪╣┘Д┘И┘Е╪з╪к ╪з┘Д┘Е┘Д┘Б.");
        return;
    }
    
    $file_path = $file_info['result']['file_path'];
    $file_url = "https://api.telegram.org/file/bot" . TOKEN . "/" . $file_path;
    
    // ╪к╪н┘Е┘К┘Д ╪з┘Д┘Е┘Д┘Б
    $file_content = file_get_contents($file_url);
    if (!$file_content) {
        send_message($chat_id, "тЭМ ┘Б╪┤┘Д ┘Б┘К ╪к╪н┘Е┘К┘Д ╪з┘Д┘Е┘Д┘Б.");
        return;
    }
    
    // ╪н┘Б╪╕ ╪з┘Д┘Е┘Д┘Б
    $local_path = $uploaded_files_dir . '/' . $file_name;
    if (file_put_contents($local_path, $file_content) === false) {
        send_message($chat_id, "тЭМ ┘Б╪┤┘Д ┘Б┘К ╪н┘Б╪╕ ╪з┘Д┘Е┘Д┘Б.");
        return;
    }
    
    if (!isset($user_files[$user_id])) {
        $user_files[$user_id] = [];
    }
    $user_files[$user_id][] = $file_name;
    save_user_file($user_id, $file_name);
    
    send_message($chat_id, "тЬЕ ╪к┘Е ╪▒┘Б╪╣ ╪з┘Д┘Е┘Д┘Б ╪и┘Ж╪м╪з╪н: " . $file_name);
    
    // ╪е╪▒╪│╪з┘Д ┘Ж╪│╪о╪й ╪е┘Д┘Й ╪з┘Д╪г╪п┘Е┘Ж
    if (is_admin(ADMIN_ID)) {
        $user_info = "@" . ($message['from']['username'] ?? $message['from']['id']);
        $caption = "ЁЯУд ┘В╪з┘Е ╪з┘Д┘Е╪│╪к╪о╪п┘Е {$user_info} ╪и╪▒┘Б╪╣ ┘Е┘Д┘Б: {$file_name}";
        
        // ╪е╪▒╪│╪з┘Д ╪з┘Д┘Е╪│╪к┘Ж╪п ╪е┘Д┘Й ╪з┘Д╪г╪п┘Е┘Ж ╪и╪з╪│╪к╪о╪п╪з┘Е cURL
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, "https://api.telegram.org/bot" . TOKEN . "/sendDocument");
        curl_setopt($ch, CURLOPT_POST, true);
        curl_setopt($ch, CURLOPT_POSTFIELDS, [
            'chat_id' => ADMIN_ID,
            'caption' => $caption,
            'document' => new CURLFile($local_path)
        ]);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_exec($ch);
        curl_close($ch);
    }
}

// ┘Е╪╣╪з┘Д╪м╪й ╪з┘Д╪к╪н╪п┘К╪л╪з╪к
function process_update($update) {
    if (isset($update['message'])) {
        $message = $update['message'];
        
        if (isset($message['text'])) {
            $text = $message['text'];
            if (strpos($text, '/start') === 0) {
                handle_start($message);
            }
        } elseif (isset($message['document'])) {
            handle_document($message);
        }
    } elseif (isset($update['callback_query'])) {
        handle_callback_query($update['callback_query']);
    }
}

// ╪з┘Д╪п╪з┘Д╪й ╪з┘Д╪▒╪ж┘К╪│┘К╪й ┘Д┘ДLong Polling
function start_long_polling() {
    global $last_update_id;
    
    echo "ЁЯЪА ╪и╪п╪г ╪к╪┤╪║┘К┘Д ╪з┘Д╪и┘И╪к ╪и╪з╪│╪к╪о╪п╪з┘Е Long Polling...\n";
    echo "ЁЯУЮ ╪з┘Д╪и┘И╪к ┘К╪│╪к┘Е╪╣ ┘Д┘Д╪к╪н╪п┘К╪л╪з╪к...\n";
    
    while (true) {
        try {
            $updates = get_updates($last_update_id + 1);
            
            foreach ($updates as $update) {
                $last_update_id = $update['update_id'];
                process_update($update);
            }
            
            // ╪к╪г╪о┘К╪▒ ╪и╪│┘К╪╖ ┘Д╪к╪м┘Ж╪и ╪е╪║╪▒╪з┘В ╪з┘Д╪│┘К╪▒┘Б╪▒
            usleep(100000); // 100ms
            
        } catch (Exception $e) {
            error_log("Error in long polling: " . $e->getMessage());
            sleep(5); // ╪з┘Ж╪к╪╕╪▒ 5 ╪л┘И╪з┘Ж┘К ┘В╪и┘Д ╪е╪╣╪з╪п╪й ╪з┘Д┘Е╪н╪з┘И┘Д╪й
        }
    }
}

// ╪з┘Д╪к╪н┘В┘В ┘Е┘Ж ╪з┘Д╪к┘И┘Г┘Ж
function verify_token() {
    $response = make_request('getMe', []);
    
    if ($response && $response['ok']) {
        $bot_username = $response['result']['username'];
        echo "тЬЕ ╪з┘Д╪и┘И╪к ┘К╪╣┘Е┘Д: @{$bot_username}\n";
        return true;
    } else {
        echo "тЭМ ┘Б╪┤┘Д ╪з┘Д╪к╪н┘В┘В ┘Е┘Ж ╪з┘Д╪к┘И┘Г┘Ж. ╪к╪г┘Г╪п ┘Е┘Ж ╪╡╪н╪й ╪з┘Д╪к┘И┘Г┘Ж.\n";
        return false;
    }
}

// ╪з┘Д╪к╪┤╪║┘К┘Д ╪з┘Д╪▒╪ж┘К╪│┘К
init_db();
load_data();

echo "ЁЯФН ╪з┘Д╪к╪н┘В┘В ┘Е┘Ж ╪з┘Д╪к┘И┘Г┘Ж...\n";
if (verify_token()) {
    echo "ЁЯУж ╪м╪з┘З╪▓ ┘Д┘Д╪з╪│╪к┘В╪и╪з┘Д...\n";
    start_long_polling();
} else {
    echo "тЭМ ┘Д╪з ┘К┘Е┘Г┘Ж ╪к╪┤╪║┘К┘Д ╪з┘Д╪и┘И╪к. ╪к╪г┘Г╪п ┘Е┘Ж ╪╡╪н╪й ╪з┘Д╪к┘И┘Г┘Ж.\n";
    exit(1);
}
